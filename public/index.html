<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pizarra de Diseño Flutter - Múltiples Pantallas y Dispositivos</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.15/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4/dist/socket.io.min.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    .canvas {
      background: linear-gradient(135deg, #e5e7eb, #f3f4f6);
      position: relative;
      overflow: hidden;
      border: 2px solid #1f2937;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: border-color 0.3s ease;
    }

    .component {
      position: absolute;
      cursor: move;
      user-select: none;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .component:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }

    .sidebar,
    .right-sidebar {
      width: 250px;
      background: #ffffff;
      border-right: 1px solid #e5e7eb;
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.05);
      transition: background-color 0.3s ease;
    }

    .right-sidebar {
      border-left: 1px solid #e5e7eb;
      border-right: none;
      box-shadow: -2px 0 8px rgba(0, 0, 0, 0.05);
    }

    .appbar {
      width: 100%;
      top: 0;
      left: 0;
      z-index: 10;
      background: #3b82f6;
      color: #ffffff;
      padding: 12px 16px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: background-color 0.3s ease;
    }

    .bottom-nav {
      width: 100%;
      bottom: 0;
      left: 0;
      z-index: 10;
      background: #3b82f6;
      color: #ffffff;
      padding: 8px 16px;
      box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
      transition: background-color 0.3s ease;
    }

    .tabbar {
      width: 100%;
      top: 0;
      left: 0;
      z-index: 9;
      background: #f9fafb;
      padding: 8px 16px;
      border-bottom: 1px solid #e5e7eb;
      transition: background-color 0.3s ease;
    }

    .fab {
      border-radius: 50%;
      width: 56px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #ef4444;
      color: #ffffff;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transition: transform 0.2s ease, background-color 0.3s ease;
    }

    .fab:hover {
      transform: scale(1.1);
      background: #dc2626;
    }

    .toggle-checkbox:checked+.toggle-label {
      background-color: #3b82f6;
    }

    .toggle-checkbox:checked+.toggle-label::after {
      transform: translateX(100%);
    }

    .toggle-label::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: #ffffff;
      border-radius: 50%;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      transition: transform 0.2s ease;
    }

    .delete-button {
      position: absolute;
      top: -10px;
      right: -10px;
      background: #ef4444;
      color: #ffffff;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
      font-weight: bold;
      z-index: 20;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      transition: background-color 0.3s ease, transform 0.2s ease;
    }

    .delete-button:hover {
      background: #dc2626;
      transform: scale(1.2);
    }
  </style>
</head>

<body class="bg-gray-100">
  <div id="root"></div>
  <script>
    window.addEventListener('error', (e) => {
      if (e.target.tagName === 'SCRIPT') {
        console.error('Error cargando script:', e.target.src);
        alert('Error cargando una dependencia. Verifica tu conexión o los CDN.');
      }
    });
  </script>
  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    const devices = [
      { name: 'Samsung Galaxy S24', width: 360, height: 800 }, 
      { name: 'Samsung Galaxy A54', width: 412, height: 914 }, 
      { name: 'Samsung Galaxy Tab S10+', width: 800, height: 1280 }, 
      { name: 'Custom', width: 375, height: 667 },
    ];

    const BASE_CANVAS_WIDTH = 375;
    const BASE_CANVAS_HEIGHT = 667;

    const generateUniqueId = () => {
      return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    };

    const Modal = ({ isOpen, onClose, onSubmit, title, children }) => {
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full">
            <h2 className="text-xl font-bold mb-4">{title}</h2>
            {children}
            <div className="flex justify-end mt-4">
              <button
                onClick={onClose}
                className="p-2 mr-2 bg-gray-300 text-black rounded"
              >
                Cancelar
              </button>
              <button
                onClick={onSubmit}
                className="p-2 bg-blue-500 text-white rounded"
              >
                Aceptar
              </button>
            </div>
          </div>
        </div>
      );
    };

    const RoomSelector = ({ onJoinRoom }) => {
      const [roomName, setRoomName] = useState('');
      const [createPassword, setCreatePassword] = useState('');
      const [joinPassword, setJoinPassword] = useState('');
      const [error, setError] = useState('');
      const [rooms, setRooms] = useState([]);
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [selectedRoom, setSelectedRoom] = useState(null);

      useEffect(() => {
        const fetchRooms = async () => {
          try {
            const response = await fetch('https://parcial-2-sw1-2025.onrender.com/api/rooms');
            const data = await response.json();
            if (Array.isArray(data)) {
              setRooms(data);
            } else {
              setError('Error al cargar las salas');
            }
          } catch (err) {
            setError('Error al conectar con el servidor');
          }
        };
        fetchRooms();
      }, []);

      const createRoom = async () => {
        try {
          const response = await fetch('https://parcial-2-sw1-2025.onrender.com/api/rooms', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: roomName, password: createPassword || null }),
          });
          const data = await response.json();
          if (data.roomName) {
            onJoinRoom(data.roomName, createPassword);
          } else {
            setError(data.error || 'No se pudo crear la sala');
          }
        } catch (err) {
          setError('Error al crear la sala');
        }
      };

      const joinRoom = async () => {
        try {
          const response = await fetch('https://parcial-2-sw1-2025.onrender.com/api/rooms/join', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ roomName: selectedRoom.name, password: joinPassword || null }),
          });
          const data = await response.json();
          if (data.success) {
            onJoinRoom(selectedRoom.name, joinPassword);
            setIsModalOpen(false);
            setJoinPassword('');
          } else {
            setError(data.error || 'No se pudo unir a la sala');
          }
        } catch (err) {
          setError('Error al unirse a la sala');
        }
      };

      const handleRoomSelect = (room) => {
        setSelectedRoom(room);
        setIsModalOpen(true);
        setError('');
      };

      return (
        <div className="p-4 max-w-md mx-auto bg-white rounded shadow">
          <h2 className="text-xl font-bold mb-4">Salas Disponibles</h2>
          {error && <p className="text-red-500 mb-2">{error}</p>}
          <div className="mb-4">
            <h3 className="text-lg font-semibold">Crear Sala</h3>
            <input
              type="text"
              placeholder="Nombre de la sala"
              value={roomName}
              onChange={(e) => setRoomName(e.target.value)}
              className="p-2 mb-2 border rounded w-full"
            />
            <input
              type="password"
              placeholder="Contraseña (opcional)"
              value={createPassword}
              onChange={(e) => setCreatePassword(e.target.value)}
              className="p-2 mb-2 border rounded w-full"
            />
            <button
              onClick={createRoom}
              className="p-2 bg-blue-500 text-white rounded w-full"
            >
              Crear Sala
            </button>
          </div>
          <div>
            <h3 className="text-lg font-semibold">Unirse a Sala</h3>
            <div className="max-h-64 overflow-y-auto mb-2">
              {rooms.length > 0 ? (
                rooms.map((room) => (
                  <div
                    key={room.id}
                    className="p-2 mb-2 bg-gray-100 rounded cursor-pointer hover:bg-gray-200"
                    onClick={() => handleRoomSelect(room)}
                  >
                    {room.name}
                  </div>
                ))
              ) : (
                <p className="text-gray-500">No hay salas disponibles</p>
              )}
            </div>
          </div>
          <Modal
            isOpen={isModalOpen}
            onClose={() => setIsModalOpen(false)}
            onSubmit={joinRoom}
            title={`Unirse a ${selectedRoom?.name || 'Sala'}`}
          >
            <input
              type="password"
              placeholder="Contraseña (si es requerida)"
              value={joinPassword}
              onChange={(e) => setJoinPassword(e.target.value)}
              className="p-2 mb-2 border rounded w-full"
            />
            {error && <p className="text-red-500">{error}</p>}
          </Modal>
        </div>
      );
    };

    const DraggableComponent = ({ id, type, xRatio, yRatio, widthRatio, heightRatio, onDrag, onDelete, canvasWidth, canvasHeight }) => {
      const componentRef = useRef(null);
      const validCanvasWidth = Number.isFinite(canvasWidth) && canvasWidth > 0 ? canvasWidth : BASE_CANVAS_WIDTH;
      const validCanvasHeight = Number.isFinite(canvasHeight) && canvasHeight > 0 ? canvasHeight : BASE_CANVAS_HEIGHT;
      const validXRatio = Number.isFinite(xRatio) ? xRatio : 0;
      const validYRatio = Number.isFinite(yRatio) ? yRatio : 0;
      const x = validXRatio * validCanvasWidth;
      const y = validYRatio * validCanvasHeight;
      const width = widthRatio * validCanvasWidth;
      const height = (type === 'appbar' || type === 'bottomNav' || type === 'tabbar') ? heightRatio * validCanvasHeight : heightRatio * validCanvasWidth;
      const [position, setPosition] = useState({ x, y });

      if (!Number.isFinite(x) || !Number.isFinite(y)) {
        console.warn(`Invalid position for component ${id}: x=${x}, y=${y}`);
        return null;
      }

      const validTypes = ['button', 'textField', 'container', 'card', 'listItem', 'appbar', 'image', 'fab', 'switch', 'checkbox', 'slider', 'bottomNav', 'tabbar'];
      if (!validTypes.includes(type)) {
        console.warn(`Invalid component type: ${type}`);
        return null;
      }

      const handleDragStart = (e) => {
        e.preventDefault();
        if (type === 'appbar' || type === 'bottomNav' || type === 'tabbar') return;
        const startX = e.clientX - position.x;
        const startY = e.clientY - position.y;

        const onMouseMove = (moveEvent) => {
          let newX = moveEvent.clientX - startX;
          let newY = moveEvent.clientY - startY;
          newX = Math.max(0, Math.min(newX, validCanvasWidth - width));
          newY = Math.max(0, Math.min(newY, validCanvasHeight - height));
          setPosition({ x: newX, y: newY });
          onDrag(id, newX / validCanvasWidth, newY / validCanvasHeight);
        };

        const onMouseUp = () => {
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', onMouseUp);
        };

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      };

      let content;
      switch (type) {
        case 'button':
          content = (
            <div
              className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-700 transition"
              style={{ width, height }}
            >
              Botón
            </div>
          );
          break;
        case 'textField':
          content = (
            <input
              type="text"
              placeholder="Campo de texto"
              className="border border-gray-300 px-3 py-2 rounded-lg focus:outline-none shadow-sm"
              style={{ width, height }}
              readOnly
            />
          );
          break;
        case 'container':
          content = (
            <div
              className="bg-gray-100 border border-gray-300 rounded-lg shadow-sm"
              style={{ width, height }}
            >
              Contenedor
            </div>
          );
          break;
        case 'card':
          content = (
            <div
              className="bg-white p-4 rounded-lg shadow-lg"
              style={{ width, height }}
            >
              <div className="font-semibold text-gray-800">Tarjeta</div>
              <div className="text-sm text-gray-600">Contenido de la tarjeta</div>
            </div>
          );
          break;
        case 'listItem':
          content = (
            <div
              className="bg-white p-3 flex items-center border-b border-gray-200"
              style={{ width, height }}
            >
              <span className="material-icons mr-3 text-gray-600">list</span>
              <span>Elemento de lista</span>
            </div>
          );
          break;
        case 'appbar':
          content = (
            <div
              className="appbar bg-blue-600 text-white p-4 flex justify-between items-center"
              style={{ width: validCanvasWidth, height }}
            >
              <span className="font-semibold">AppBar</span>
              <div className="flex space-x-3">
                <span className="material-icons">search</span>
                <span className="material-icons">more_vert</span>
              </div>
            </div>
          );
          break;
        case 'image':
          content = (
            <div
              className="bg-gray-200 rounded-lg flex items-center justify-center shadow-md"
              style={{ width, height }}
            >
              Imagen
            </div>
          );
          break;
        case 'fab':
          content = (
            <div
              className="fab bg-red-500 text-white shadow-lg hover:bg-red-600 transition"
              style={{ width, height }}
            >
              <span className="material-icons">add</span>
            </div>
          );
          break;
        case 'switch':
          content = (
            <div className="flex items-center" style={{ width, height }}>
              <div className="relative inline-block w-10 mr-2 align-middle select-none">
                <input
                  type="checkbox"
                  className="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"
                  readOnly
                />
                <label className="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300"></label>
              </div>
              <span>Interruptor</span>
            </div>
          );
          break;
        case 'checkbox':
          content = (
            <div className="flex items-center" style={{ width, height }}>
              <input type="checkbox" className="w-5 h-5 mr-2 accent-blue-600" readOnly />
              <span>Casilla de verificación</span>
            </div>
          );
          break;
        case 'slider':
          content = (
            <div style={{ width, height }}>
              <input
                type="range"
                min="0"
                max="100"
                defaultValue="50"
                className="w-full accent-blue-600"
                readOnly
              />
              <span>Deslizador</span>
            </div>
          );
          break;
        case 'bottomNav':
          content = (
            <div
              className="bottom-nav bg-blue-600 text-white p-3 flex justify-around items-center"
              style={{ width: validCanvasWidth, height }}
            >
              <span className="material-icons">home</span>
              <span className="material-icons">favorite</span>
              <span className="material-icons">person</span>
            </div>
          );
          break;
        case 'tabbar':
          content = (
            <div
              className="tabbar bg-gray-100 p-2 flex justify-around items-center"
              style={{ width: validCanvasWidth, height }}
            >
              <span className="px-4 py-2 bg-white rounded-lg shadow-sm">Pestaña 1</span>
              <span className="px-4 py-2">Pestaña 2</span>
              <span className="px-4 py-2">Pestaña 3</span>
            </div>
          );
          break;
      }

      return (
        <div
          ref={componentRef}
          className={`component ${type === 'appbar' ? 'appbar' : type === 'bottomNav' ? 'bottom-nav' : type === 'tabbar' ? 'tabbar' : ''}`}
          style={{ left: x, top: y }}
          onMouseDown={handleDragStart}
        >
          {content}
          <div className="delete-button" onClick={() => onDelete(id)}>
            X
          </div>
        </div>
      );
    };

    const App = () => {
      const [screens, setScreens] = useState([]);
      const [activeScreenId, setActiveScreenId] = useState(null);
      const [roomName, setRoomName] = useState(null);
      const [password, setPassword] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      const canvasRef = useRef(null);
      const socketRef = useRef(null);
      const pendingScreenIdRef = useRef(null);

      const handleJoinRoom = (newRoomName, roomPassword) => {
        setRoomName(newRoomName);
        setPassword(roomPassword);
        setIsLoading(true);
      };

      const handleExitRoom = () => {
        if (socketRef.current) {
          socketRef.current.disconnect();
          socketRef.current = null;
        }
        setRoomName(null);
        setPassword('');
        setScreens([]);
        setActiveScreenId(null);
        setIsLoading(false);
      };

      useEffect(() => {
        if (roomName) {
          socketRef.current = io('https://parcial-2-sw1-2025.onrender.com', {
            auth: { roomName, password },
          });

          socketRef.current.on('connect_error', (err) => {
            console.error('Socket.IO connection error:', err);
            setIsLoading(false);
            setRoomName(null);
            setPassword('');
            alert('Error al conectar con el servidor. Verifica la conexión o la contraseña.');
          });

          socketRef.current.on('init', (initialScreens) => {
            const sanitizedScreens = initialScreens.map((screen) => ({
              ...screen,
              components: Array.isArray(screen.components) ? screen.components.map(comp => ({
                ...comp,
                id: comp.id || generateUniqueId(),
                xRatio: Number.isFinite(comp.xRatio) ? comp.xRatio : 0.1,
                yRatio: Number.isFinite(comp.yRatio) ? comp.yRatio : 0.1,
              })) : [],
            }));
            setScreens(sanitizedScreens);
            if (sanitizedScreens.length > 0 && !activeScreenId) {
              setActiveScreenId(sanitizedScreens[0].id);
            }
            setIsLoading(false);
          });

          socketRef.current.on('updateScreens', (updatedScreens) => {
            const sanitizedScreens = updatedScreens.map((screen) => ({
              ...screen,
              components: Array.isArray(screen.components) ? screen.components.map(comp => ({
                ...comp,
                id: comp.id || generateUniqueId(),
                xRatio: Number.isFinite(comp.xRatio) ? comp.xRatio : 0.1,
                yRatio: Number.isFinite(comp.yRatio) ? comp.yRatio : 0.1,
              })) : [],
            }));
            setScreens(sanitizedScreens);
            if (pendingScreenIdRef.current) {
              const newScreen = sanitizedScreens.find(s => s.name === pendingScreenIdRef.current.name);
              if (newScreen) {
                setActiveScreenId(newScreen.id);
                pendingScreenIdRef.current = null;
              }
            }
            if (sanitizedScreens.length > 0 && !sanitizedScreens.some((screen) => screen.id === activeScreenId)) {
              setActiveScreenId(sanitizedScreens[0].id);
            }
          });

          return () => {
            if (socketRef.current) {
              socketRef.current.disconnect();
            }
          };
        }
      }, [roomName, activeScreenId]);

      const activeScreen = screens.find((screen) => screen.id === activeScreenId);

      const handleComponentDrag = (id, xRatio, yRatio) => {
        if (activeScreenId) {
          socketRef.current.emit('moveComponent', {
            screenId: activeScreenId,
            componentId: id,
            xRatio,
            yRatio,
          });
        }
      };

      const deleteComponent = (id) => {
        if (activeScreenId) {
          socketRef.current.emit('deleteComponent', {
            screenId: activeScreenId,
            componentId: id,
          });
        }
      };

      const validComponentTypes = [
        'button', 'textField', 'container', 'card', 'listItem', 'appbar', 'image',
        'fab', 'switch', 'checkbox', 'slider', 'bottomNav', 'tabbar'
      ];

      const addComponent = (type, xRatio, yRatio) => {
        if (!activeScreen || isLoading) {
          console.warn('Cannot add component: activeScreen not ready or loading');
          return;
        }
        if (!validComponentTypes.includes(type)) {
          console.warn(`Invalid component type: ${type}`);
          return;
        }
        const canvasWidth = Number.isFinite(activeScreen.device?.width) && activeScreen.device.width > 0 ? activeScreen.device.width : BASE_CANVAS_WIDTH;
        const canvasHeight = Number.isFinite(activeScreen.device?.height) && activeScreen.device.height > 0 ? activeScreen.device.height : BASE_CANVAS_HEIGHT;

        const baseWidth = type === 'card' || type === 'listItem' ? 256 :
          type === 'image' ? 192 :
            type === 'container' ? 192 :
              type === 'slider' ? 192 :
                type === 'appbar' || type === 'bottomNav' || type === 'tabbar' ? canvasWidth :
                  type === 'textField' ? 160 :
                    type === 'switch' || type === 'checkbox' ? 120 : 80;
        const baseHeight = type === 'card' ? 112 :
          type === 'image' ? 128 :
            type === 'container' ? 96 :
              type === 'listItem' ? 48 :
                type === 'appbar' || type === 'bottomNav' || type === 'tabbar' ? 56 : 48;
        const widthRatio = (type === 'appbar' || type === 'bottomNav' || type === 'tabbar' ? canvasWidth : baseWidth) / BASE_CANVAS_WIDTH;
        const heightRatio = (type === 'appbar' || type === 'bottomNav' || type === 'tabbar' ? baseHeight : baseHeight) / (type === 'appbar' || type === 'bottomNav' || type === 'tabbar' ? canvasHeight : BASE_CANVAS_WIDTH);
        const boundedXRatio = type === 'appbar' || type === 'tabbar' ? 0 :
          Number.isFinite(xRatio) ? Math.max(0, Math.min(xRatio, 1 - widthRatio)) : 0.1;
        const boundedYRatio = type === 'appbar' || type === 'tabbar' ? 0 :
          type === 'bottomNav' ? 1 - heightRatio :
            Number.isFinite(yRatio) ? Math.max(0, Math.min(yRatio, 1 - heightRatio)) : 0.1;

        const newComponent = {
          id: generateUniqueId(),
          type,
          xRatio: boundedXRatio,
          yRatio: boundedYRatio,
          widthRatio,
          heightRatio,
        };

        console.log(`Adding component: ${type}, xRatio=${boundedXRatio.toFixed(3)}, yRatio=${boundedYRatio.toFixed(3)}`);
        socketRef.current.emit('addComponent', {
          screenId: activeScreenId,
          component: newComponent,
        });
      };

      const addScreen = () => {
        const newScreen = {
          name: `Pantalla ${screens.length + 1}`,
          components: [],
          device: devices[0],
        };
        pendingScreenIdRef.current = newScreen;
        socketRef.current.emit('addScreen', newScreen);
      };

      const deleteScreen = (id) => {
        if (screens.length === 1) return;
        socketRef.current.emit('deleteScreen', id);
      };

      const renameScreen = (id, newName) => {
        socketRef.current.emit('renameScreen', { screenId: id, newName });
      };

      const changeDevice = (deviceName, customWidth, customHeight) => {
        let selectedDevice = devices.find((d) => d.name === deviceName);
        if (deviceName === 'Custom' && customWidth && customHeight) {
          const width = parseInt(customWidth) || 375;
          const height = parseInt(customHeight) || 667;
          selectedDevice = { name: 'Custom', width, height };
        }
        if (!selectedDevice) {
          console.warn(`Invalid device selected: ${deviceName}`);
          return;
        }
        console.log(`Changing device for all screens to: ${selectedDevice.name} (${selectedDevice.width}x${selectedDevice.height})`);
        screens.forEach((screen) => {
          socketRef.current.emit('changeDevice', { screenId: screen.id, device: selectedDevice });
        });
      };

      const generateDesignFromPrompt = async (prompt) => {
        try {
          const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer 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',
            },
            body: JSON.stringify({
              model: 'gpt-3.5-turbo',
              messages: [
                {
                  role: 'system',
                  content: `
                    Eres un diseñador de UI Flutter experto. Convierte prompts de diseño en una lista de componentes Flutter con sus posiciones en un lienzo.
                    Devuelve SOLO un JSON válido con una lista de objetos, cada uno con {id, type, x, y}.
                    Tipos válidos: button, textField, card, appbar, bottomNav, tabbar, image, fab, switch, checkbox, slider, container, listItem.
                    Las posiciones x, y deben ser números enteros dentro de un lienzo de ${activeScreen?.device.width || BASE_CANVAS_WIDTH}px de ancho y ${activeScreen?.device.height || BASE_CANVAS_HEIGHT}px de alto.
                    Asegúrate de que los componentes no se salgan del lienzo y que las posiciones sean razonables (por ejemplo, appbar en y=0, bottomNav en la parte inferior).
                    Si el prompt menciona "centrado", calcula la posición x para centrar el componente según su ancho aproximado.
                    Ejemplo:
                    [
                      {"id": "1", "type": "appbar", "x": 0, "y": 0},
                      {"id": "2", "type": "button", "x": 147, "y": 300}
                    ]
                  `,
                },
                {
                  role: 'user',
                  content: `Genera un diseño Flutter basado en: ${prompt}`,
                },
              ],
              temperature: 0.7,
              max_tokens: 4096,
            }),
          });

          if (!response.ok) {
            throw new Error(`Error de API: ${response.status} ${response.statusText}`);
          }

          const data = await response.json();
          let components;
          try {
            components = JSON.parse(data.choices[0].message.content);
          } catch (e) {
            throw new Error('La respuesta de la API no es un JSON válido');
          }

          components.forEach((comp) => {
            if (!validComponentTypes.includes(comp.type)) {
              console.warn(`Tipo de componente no válido: ${comp.type}`);
              return;
            }
            if (!comp.id) {
              comp.id = generateUniqueId();
            }
            const xRatio = Number.isFinite(comp.x / (activeScreen?.device.width || BASE_CANVAS_WIDTH)) ?
              comp.x / (activeScreen?.device.width || BASE_CANVAS_WIDTH) : 0.1;
            const yRatio = Number.isFinite(comp.y / (activeScreen?.device.height || BASE_CANVAS_HEIGHT)) ?
              comp.y / (activeScreen?.device.height || BASE_CANVAS_HEIGHT) : 0.1;
            addComponent(comp.type, xRatio, yRatio);
          });
        } catch (error) {
          console.error('Error en generateDesignFromPrompt:', error);
          alert('No se pudo generar el diseño. Verifica la conexión, la clave de API, o el prompt.');
        }
      };

      const generateDesignFromSketch = async (imageFile) => {
        if (!imageFile) {
          alert('Por favor, sube una imagen primero.');
          return;
        }

        try {
          const toBase64 = (file) =>
            new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.readAsDataURL(file);
              reader.onload = () => resolve(reader.result);
              reader.onerror = (error) => reject(error);
            });
          const base64Image = await toBase64(imageFile);

          const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer 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',
            },
            body: JSON.stringify({
              model: 'gpt-4',
              messages: [
                {
                  role: 'system',
                  content: `
                    Eres un diseñador de UI Flutter experto. Analiza la imagen de un boceto de interfaz y convierte los elementos visuales en una lista de componentes Flutter con sus posiciones en un lienzo.
                    Devuelve SOLO un JSON válido con una lista de objetos, cada uno con {id, type, x, y}.
                    Tipos válidos: button, textField, card, appbar, bottomNav, tabbar, image, fab, switch, checkbox, slider, container, listItem.
                    Las posiciones x, y deben ser números enteros dentro de un lienzo de ${activeScreen?.device.width || BASE_CANVAS_WIDTH}px de ancho y ${activeScreen?.device.height || BASE_CANVAS_HEIGHT}px de alto.
                    Normaliza las posiciones del boceto para que coincidan con el lienzo (por ejemplo, un botón en el centro del boceto debe estar centrado en el lienzo).
                    Asegúrate de que los componentes no se salgan del lienzo y que las posiciones sean razonables (por ejemplo, appbar en y=0, bottomNav en la parte inferior).
                    Ejemplo:
                    [
                      {"id": "1", "type": "appbar", "x": 0, "y": 0},
                      {"id": "2", "type": "button", "x": 147, "y": 300}
                    ]
                  `,
                },
                {
                  role: 'user',
                  content: [
                    {
                      type: 'text',
                      text: 'Analiza este boceto de interfaz y genera un diseño Flutter con los componentes identificados.',
                    },
                    {
                      type: 'image_url',
                      image_url: {
                        url: base64Image,
                      },
                    },
                  ],
                },
              ],
              temperature: 0.7,
              max_tokens: 4096,
            }),
          });

          if (!response.ok) {
            throw new Error(`Error de API: ${response.status} ${response.statusText}`);
          }

          const data = await response.json();
          let components;
          try {
            components = JSON.parse(data.choices[0].message.content);
          } catch (e) {
            throw new Error('La respuesta de la API no es un JSON válido');
          }

          components.forEach((comp) => {
            if (!validComponentTypes.includes(comp.type)) {
              console.warn(`Tipo de componente no válido: ${comp.type}`);
              return;
            }
            if (!comp.id) {
              comp.id = generateUniqueId();
            }
            const xRatio = Number.isFinite(comp.x / (activeScreen?.device.width || BASE_CANVAS_WIDTH)) ?
              comp.x / (activeScreen?.device.width || BASE_CANVAS_WIDTH) : 0.1;
            const yRatio = Number.isFinite(comp.y / (activeScreen?.device.height || BASE_CANVAS_HEIGHT)) ?
              comp.y / (activeScreen?.device.height || BASE_CANVAS_HEIGHT) : 0.1;
            addComponent(comp.type, xRatio, yRatio);
          });
        } catch (error) {
          console.error('Error en generateDesignFromSketch:', error);
          alert('No se pudo generar el diseño. Verifica la conexión, la clave de API, o la imagen.');
        }
      };

      const exportToFlutter = () => {
        if (!screens.length) {
          alert('No hay pantallas para exportar');
          return;
        }
        const BASE_CANVAS_WIDTH = 375;
        const BASE_CANVAS_HEIGHT = 667;
        let code = `import 'package:flutter/material.dart';\n\n`;
        code += `void main() => runApp(MyApp());\n\n`;
        code += `class MyApp extends StatelessWidget {\n`;
        code += `  @override\n`;
        code += `  Widget build(BuildContext context) {\n`;
        code += `    return MaterialApp(\n`;
        code += `      initialRoute: '/${screens[0].name.replace(/\s+/g, '')}',\n`;
        code += `      routes: {\n`;
        screens.forEach((screen) => {
          code += `        '/${screen.name.replace(/\s+/g, '')}': (context) => ${screen.name.replace(/\s+/g, '')}Screen(),\n`;
        });
        code += `      },\n`;
        code += `    );\n`;
        code += `  }\n`;
        code += `}\n\n`;

        screens.forEach((screen, index) => {
          const screenName = screen.name.replace(/\s+/g, '');
          const canvasWidth = screen.device.width || BASE_CANVAS_WIDTH;
          const canvasHeight = screen.device.height || BASE_CANVAS_HEIGHT;
          console.log(`Generating screen: ${screenName}, canvas: ${canvasWidth}x${canvasHeight}`);
          code += `class ${screenName}Screen extends StatelessWidget {\n`;
          code += `  @override\n`;
          code += `  Widget build(BuildContext context) {\n`;
          code += `    return Scaffold(\n`;

          const appbar = screen.components.find((comp) => comp.type === 'appbar');
          if (appbar) {
            code += `      appBar: AppBar(\n`;
            code += `        title: Text('${screen.name}'),\n`;
            code += `        actions: [\n`;
            code += `          IconButton(icon: Icon(Icons.search), onPressed: () {}),\n`;
            code += `          IconButton(icon: Icon(Icons.more_vert), onPressed: () {}),\n`;
            code += `        ],\n`;
            code += `      ),\n`;
          }

          code += `      body: Stack(\n`;
          code += `        children: [\n`;

          if (screens.length > 1) {
            if (index < screens.length - 1) {
              code += `          Positioned(\n`;
              code += `            bottom: 16,\n`;
              code += `            right: 16,\n`;
              code += `            child: ElevatedButton(\n`;
              code += `              onPressed: () => Navigator.pushNamed(context, '/${screens[index + 1].name.replace(/\s+/g, '')}'),\n`;
              code += `              child: Text('Siguiente'),\n`;
              code += `            ),\n`;
              code += `          ),\n`;
            }
            if (index > 0) {
              code += `          Positioned(\n`;
              code += `            bottom: 16,\n`;
              code += `            left: 16,\n`;
              code += `            child: ElevatedButton(\n`;
              code += `              onPressed: () => Navigator.pushNamed(context, '/${screens[index - 1].name.replace(/\s+/g, '')}'),\n`;
              code += `              child: Text('Anterior'),\n`;
              code += `            ),\n`;
              code += `          ),\n`;
            }
          }

          screen.components.forEach((comp) => {
            if (!comp.type || !['button', 'textField', 'container', 'card', 'listItem', 'image', 'fab', 'switch', 'checkbox', 'slider'].includes(comp.type)) {
              console.warn(`Skipping component with invalid type: ${comp.type}`, comp);
              return;
            }
            if (comp.type !== 'appbar' && comp.type !== 'bottomNav' && comp.type !== 'tabbar') {
              const x = comp.xRatio * canvasWidth;
              const y = comp.yRatio * canvasHeight;
              const width = comp.widthRatio * canvasWidth;
              const height = comp.heightRatio * canvasWidth;
              console.log(`Component ${comp.type}: x=${x.toFixed(1)}, y=${y.toFixed(1)}, width=${width.toFixed(1)}, height=${height.toFixed(1)}`);
              code += `          Positioned(\n`;
              code += `            left: ${x.toFixed(1)},\n`;
              code += `            top: ${y.toFixed(1)},\n`;
              switch (comp.type) {
                case 'button':
                  code += `            child: ElevatedButton(\n`;
                  code += `              onPressed: () {},\n`;
                  code += `              child: Text('Botón'),\n`;
                  code += `            ),\n`;
                  break;
                case 'textField':
                  code += `            child: SizedBox(\n`;
                  code += `              width: ${width.toFixed(1)},\n`;
                  code += `              height: ${height.toFixed(1)},\n`;
                  code += `              child: TextField(\n`;
                  code += `                decoration: InputDecoration(\n`;
                  code += `                  border: OutlineInputBorder(),\n`;
                  code += `                  hintText: 'Campo de texto',\n`;
                  code += `                ),\n`;
                  code += `              ),\n`;
                  code += `            ),\n`;
                  break;
                case 'container':
                  code += `            child: Container(\n`;
                  code += `              width: ${width.toFixed(1)},\n`;
                  code += `              height: ${height.toFixed(1)},\n`;
                  code += `              decoration: BoxDecoration(\n`;
                  code += `                border: Border.all(color: Colors.grey),\n`;
                  code += `                borderRadius: BorderRadius.circular(8),\n`;
                  code += `              ),\n`;
                  code += `              child: Center(child: Text('Contenedor')),\n`;
                  code += `            ),\n`;
                  break;
                case 'card':
                  code += `            child: SizedBox(\n`;
                  code += `              width: ${width.toFixed(1)},\n`;
                  code += `              height: ${height.toFixed(1)},\n`;
                  code += `              child: Card(\n`;
                  code += `                child: Padding(\n`;
                  code += `                  padding: EdgeInsets.all(16),\n`;
                  code += `                  child: Column(\n`;
                  code += `                    children: [\n`;
                  code += `                      Text('Tarjeta', style: TextStyle(fontWeight: FontWeight.bold)),\n`;
                  code += `                      Text('Contenido de la tarjeta', style: TextStyle(fontSize: 12)),\n`;
                  code += `                    ],\n`;
                  code += `                  ),\n`;
                  code += `                ),\n`;
                  code += `              ),\n`;
                  code += `            ),\n`;
                  break;
                case 'listItem':
                  code += `            child: SizedBox(\n`;
                  code += `              width: ${width.toFixed(1)},\n`;
                  code += `              height: ${height.toFixed(1)},\n`;
                  code += `              child: ListTile(\n`;
                  code += `                leading: Icon(Icons.list),\n`;
                  code += `                title: Text('Elemento de lista'),\n`;
                  code += `              ),\n`;
                  code += `            ),\n`;
                  break;
                case 'image':
                  code += `            child: Container(\n`;
                  code += `              width: ${width.toFixed(1)},\n`;
                  code += `              height: ${height.toFixed(1)},\n`;
                  code += `              decoration: BoxDecoration(\n`;
                  code += `                color: Colors.grey[300],\n`;
                  code += `                borderRadius: BorderRadius.circular(8),\n`;
                  code += `              ),\n`;
                  code += `              child: Center(child: Text('Imagen')),\n`;
                  code += `            ),\n`;
                  break;
                case 'fab':
                  code += `            child: SizedBox(\n`;
                  code += `              width: ${width.toFixed(1)},\n`;
                  code += `              height: ${width.toFixed(1)},\n`;
                  code += `              child: FloatingActionButton(\n`;
                  code += `                onPressed: () {},\n`;
                  code += `                child: Icon(Icons.add),\n`;
                  code += `              ),\n`;
                  code += `            ),\n`;
                  break;
                case 'switch':
                  code += `            child: SizedBox(\n`;
                  code += `              width: ${width.toFixed(1)},\n`;
                  code += `              height: ${height.toFixed(1)},\n`;
                  code += `              child: Switch(\n`;
                  code += `                value: false,\n`;
                  code += `                onChanged: (value) {},\n`;
                  code += `              ),\n`;
                  code += `            ),\n`;
                  break;
                case 'checkbox':
                  code += `            child: SizedBox(\n`;
                  code += `              width: ${width.toFixed(1)},\n`;
                  code += `              height: ${height.toFixed(1)},\n`;
                  code += `              child: Checkbox(\n`;
                  code += `                value: false,\n`;
                  code += `                onChanged: (value) {},\n`;
                  code += `              ),\n`;
                  break;
                case 'slider':
                  code += `            child: SizedBox(\n`;
                  code += `              width: ${width.toFixed(1)},\n`;
                  code += `              height: ${height.toFixed(1)},\n`;
                  code += `              child: Slider(\n`;
                  code += `                value: 50,\n`;
                  code += `                min: 0,\n`;
                  code += `                max: 100,\n`;
                  code += `                onChanged: (value) {},\n`;
                  code += `              ),\n`;
                  break;
              }
              code += `          ),\n`;
            }
          });
          code += `        ],\n`;
          code += `      ),\n`;

          const bottomNav = screen.components.find((comp) => comp.type === 'bottomNav');
          if (bottomNav) {
            code += `      bottomNavigationBar: BottomNavigationBar(\n`;
            code += `        items: [\n`;
            code += `          BottomNavigationBarItem(icon: Icon(Icons.home), label: 'Home'),\n`;
            code += `          BottomNavigationBarItem(icon: Icon(Icons.favorite), label: 'Favorite'),\n`;
            code += `          BottomNavigationBarItem(icon: Icon(Icons.person), label: 'Profile'),\n`;
            code += `        ],\n`;
            code += `        currentIndex: 0,\n`;
            code += `        onTap: (index) {},\n`;
            code += `      ),\n`;
          }

          const tabbar = screen.components.find((comp) => comp.type === 'tabbar');
          if (tabbar) {
            code += `      // Nota: TabBar requiere un TabBarController para funcionar correctamente.\n`;
            code += `      // Ejemplo de implementación:\n`;
            code += `      // body: DefaultTabController(\n`;
            code += `      //   length: 3,\n`;
            code += `      //   child: Column(\n`;
            code += `      //     children: [\n`;
            code += `      //       TabBar(tabs: [\n`;
            code += `      //         Tab(text: 'Pestaña 1'),\n`;
            code += `      //         Tab(text: 'Pestaña 2'),\n`;
            code += `      //         Tab(text: 'Pestaña 3'),\n`;
            code += `      //       ]),\n`;
            code += `      //       Expanded(child: TabBarView(...)),\n`;
            code += `      //     ],\n`;
            code += `      //   ),\n`;
            code += `      // ),\n`;
          }

          code += `    );\n`;
          code += `  }\n`;
          code += `}\n\n`;
        });

        console.log('Generated Flutter code:\n', code);
        const blob = new Blob([code], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `MyApp.dart`;
        a.click();
        URL.revokeObjectURL(url);
      };

      const handleDrop = (e) => {
        e.preventDefault();
        if (!canvasRef.current || !activeScreen) {
          console.error('Canvas o pantalla no está lista');
          return;
        }
        const type = e.dataTransfer.getData('component-type');
        const rect = canvasRef.current.getBoundingClientRect();
        const canvasWidth = Number.isFinite(activeScreen.device?.width) && activeScreen.device.width > 0 ? activeScreen.device.width : BASE_CANVAS_WIDTH;
        const canvasHeight = Number.isFinite(activeScreen.device?.height) && activeScreen.device.height > 0 ? activeScreen.device.height : BASE_CANVAS_HEIGHT;

        if (canvasWidth <= 0 || canvasHeight <= 0) {
          console.error('Invalid canvas dimensions:', { canvasWidth, canvasHeight });
          return;
        }

        const baseWidth = type === 'card' || type === 'listItem' ? 256 :
          type === 'image' ? 192 :
            type === 'container' ? 192 :
              type === 'slider' ? 192 :
                type === 'appbar' || type === 'bottomNav' || type === 'tabbar' ? canvasWidth :
                  type === 'textField' ? 160 :
                    type === 'switch' || type === 'checkbox' ? 120 : 80;
        const baseHeight = type === 'card' ? 112 :
          type === 'image' ? 128 :
            type === 'container' ? 96 :
              type === 'listItem' ? 48 :
                type === 'appbar' || type === 'bottomNav' || type === 'tabbar' ? 56 : 48;
        const widthRatio = (type === 'appbar' || type === 'bottomNav' || type === 'tabbar' ? canvasWidth : baseWidth) / BASE_CANVAS_WIDTH;
        const heightRatio = (type === 'appbar' || type === 'bottomNav' || type === 'tabbar' ? baseHeight : baseHeight) / (type === 'appbar' || type === 'bottomNav' || type === 'tabbar' ? canvasHeight : BASE_CANVAS_WIDTH);
        let xRatio = type === 'appbar' || type === 'tabbar' ? 0 : (e.clientX - rect.left - 20) / canvasWidth;
        let yRatio = type === 'appbar' || type === 'tabbar' ? 0 : type === 'bottomNav' ? 1 - heightRatio : (e.clientY - rect.top - 20) / canvasHeight;

        xRatio = Number.isFinite(xRatio) ? Math.max(0, Math.min(xRatio, 1 - widthRatio)) : 0.1;
        yRatio = Number.isFinite(yRatio) ? Math.max(0, Math.min(yRatio, 1 - heightRatio)) : 0.1;

        addComponent(type, xRatio, yRatio);
      };

      const handleDragOver = (e) => {
        e.preventDefault();
      };

      const Sidebar = () => {
        const componentsList = [
          { type: 'button', label: 'Botón' },
          { type: 'textField', label: 'Campo de Texto' },
          { type: 'container', label: 'Contenedor' },
          { type: 'card', label: 'Tarjeta' },
          { type: 'listItem', label: 'Elemento de Lista' },
          { type: 'appbar', label: 'AppBar' },
          { type: 'image', label: 'Imagen' },
          { type: 'fab', label: 'Botón de Acción Flotante' },
          { type: 'switch', label: 'Interruptor' },
          { type: 'checkbox', label: 'Casilla de Verificación' },
          { type: 'slider', label: 'Deslizador' },
          { type: 'bottomNav', label: 'Barra de Navegación Inferior' },
          { type: 'tabbar', label: 'Barra de Pestañas' },
        ];
        const [selectedComponent, setSelectedComponent] = useState(componentsList[0].type);
        const [prompt, setPrompt] = useState('');
        const [sketchImage, setSketchImage] = useState(null);
        const [sketchPreview, setSketchPreview] = useState(null);

        const validTypes = componentsList.map(comp => comp.type);

        const handleDragStart = (e, type) => {
          if (validTypes.includes(type)) {
            e.dataTransfer.setData('component-type', type);
          } else {
            console.warn(`Invalid drag component type: ${type}`);
          }
        };

        const handleAddComponent = (e) => {
          if (!validTypes.includes(selectedComponent)) {
            console.warn(`Invalid component type selected: ${selectedComponent}`);
            return;
          }
          console.log(`Adding component: ${selectedComponent}`);
          addComponent(selectedComponent, 0.1, 0.1);
        };

        const handleImageUpload = (e) => {
          const file = e.target.files[0];
          if (file && ['image/png', 'image/jpeg'].includes(file.type)) {
            setSketchImage(file);
            const reader = new FileReader();
            reader.onload = () => setSketchPreview(reader.result);
            reader.readAsDataURL(file);
          } else {
            alert('Por favor, sube una imagen PNG o JPEG.');
          }
        };

        return (
          <div className="sidebar p-4">

            <h2 className="text-xl font-bold mb-4">Diseño por Prompt</h2>
            <textarea
              value={prompt}
              onChange={(e) => setPrompt(e.target.value)}
              placeholder="Ejemplo: Crea una pantalla con un botón centrado y una AppBar"
              className="p-2 mb-2 border rounded w-full h-24"
            />
            <button
              onClick={() => generateDesignFromPrompt(prompt)}
              className="p-2 mb-2 bg-blue-500 text-white rounded w-full"
            >
              Generar Diseño
            </button>
            <h2 className="text-xl font-bold mb-4 mt-6">Diseño por Boceto</h2>
            <input
              type="file"
              accept="image/png,image/jpeg"
              onChange={handleImageUpload}
              className="p-2 mb-2 border rounded w-full"
            />
            {sketchPreview && (
              <div className="mb-2">
                <img src={sketchPreview} alt="Previsualización del boceto" className="max-w-full h-auto rounded" />
              </div>
            )}
            <button
              onClick={() => generateDesignFromSketch(sketchImage)}
              disabled={!sketchImage}
              className={`p-2 mb-2 w-full text-white rounded ${sketchImage ? 'bg-blue-500 hover:bg-blue-600' : 'bg-gray-400 cursor-not-allowed'}`}
            >
              Generar desde Boceto
            </button>
            <h2 className="text-xl font-bold mt-6 mb-4">Componentes</h2>
            <select
              value={selectedComponent}
              onChange={(e) => setSelectedComponent(e.target.value)}
              className="p-2 mb-2 border rounded w-full"
            >
              {componentsList.map((comp) => (
                <option key={comp.type} value={comp.type}>
                  {comp.label}
                </option>
              ))}
            </select>
            <button
              onClick={handleAddComponent}
              className="p-2 mb-2 bg-blue-500 text-white rounded w-full"
              draggable
              onDragStart={(e) => handleDragStart(e, selectedComponent)}
            >
              Añadir Componente
            </button>

          </div>
        );
      };

      const RightSidebar = () => {
        const [customWidth, setCustomWidth] = useState('');
        const [customHeight, setCustomHeight] = useState('');

        const applyCustomDevice = () => {
          const width = parseInt(customWidth);
          const height = parseInt(customHeight);
          if (width > 0 && height > 0) {
            changeDevice('Custom', width, height);
          } else {
            alert('Por favor, ingresa un ancho y alto válidos.');
          }
        };

        return (
          <div className="right-sidebar p-4">
            <h2 className="text-xl font-bold mb-4">Sala Actual</h2>
            <button
              onClick={handleExitRoom}
              className="p-2 mb-4 bg-red-600 text-white rounded w-full hover:bg-red-700"
            >
              Volver a Selección de Sala
            </button>
            <h2 className="text-xl font-bold mb-4">Exportar</h2>
            <button
              onClick={exportToFlutter}
              className="p-2 mb-2 bg-green-500 text-white rounded w-full"
            >
              Exportar a Flutter
            </button>
            <h2 className="text-xl font-bold mt-6 mb-4">Dispositivo</h2>
            <select
              value={activeScreen?.device.name || ''}
              onChange={(e) => changeDevice(e.target.value, customWidth, customHeight)}
              className="p-2 mb-2 border rounded w-full"
            >
              {devices.map((device) => (
                <option key={device.name} value={device.name}>
                  {device.name} ({device.width}x{device.height})
                </option>
              ))}
            </select>
            {activeScreen?.device.name === 'Custom' && (
              <div className="mt-2">
                <input
                  type="number"
                  placeholder="Ancho (px)"
                  value={customWidth}
                  onChange={(e) => setCustomWidth(e.target.value)}
                  className="p-2 mb-2 border rounded w-full"
                />
                <input
                  type="number"
                  placeholder="Alto (px)"
                  value={customHeight}
                  onChange={(e) => setCustomHeight(e.target.value)}
                  className="p-2 mb-2 border rounded w-full"
                />
                <button
                  onClick={applyCustomDevice}
                  className="p-2 bg-blue-500 text-white rounded w-full"
                >
                  Aplicar Tamaño
                </button>
              </div>
            )}
            <h2 className="text-xl font-bold mt-6 mb-4">Pantallas</h2>
            <button
              onClick={addScreen}
              className="p-2 mb-2 bg-blue-500 text-white rounded w-full"
            >
              Nueva Pantalla
            </button>
            {screens.map((screen) => (
              <div
                key={screen.id}
                className={`p-2 mb-2 flex justify-between items-center rounded ${screen.id === activeScreenId ? 'bg-blue-100' : 'bg-gray-100'}`}
              >
                <input
                  type="text"
                  value={screen.name}
                  onChange={(e) => renameScreen(screen.id, e.target.value)}
                  className="border-none bg-transparent w-full"
                />
                {screens.length > 1 && (
                  <button
                    onClick={() => deleteScreen(screen.id)}
                    className="text-red-500 hover:text-red-700"
                  >
                    X
                  </button>
                )}
                <button
                  onClick={() => setActiveScreenId(screen.id)}
                  className="ml-2 text-blue-500 hover:text-blue-700"
                >
                  Ver
                </button>
              </div>
            ))}
          </div>
        );
      };

      if (!roomName) {
        return <RoomSelector onJoinRoom={handleJoinRoom} />;
      }

      if (isLoading || !activeScreen || !screens.length || !Array.isArray(activeScreen.components)) {
        return <div>Cargando...</div>;
      }

      return (
        <div className="flex">
          <Sidebar />
          <div className="flex-1 p-4">
            <h1 className="text-2xl font-bold mb-4">
              Pizarra de Diseño Flutter - {activeScreen.name} ({activeScreen.device.name})
            </h1>
            <div
              ref={canvasRef}
              className="canvas"
              style={{ width: activeScreen.device.width, height: activeScreen.device.height }}
              onDrop={handleDrop}
              onDragOver={handleDragOver}
            >
              {activeScreen.components.map((comp) => (
                <DraggableComponent
                  key={comp.id}
                  id={comp.id}
                  type={comp.type}
                  xRatio={comp.xRatio}
                  yRatio={comp.yRatio}
                  widthRatio={comp.widthRatio}
                  heightRatio={comp.heightRatio}
                  onDrag={handleComponentDrag}
                  onDelete={deleteComponent}
                  canvasWidth={activeScreen.device.width}
                  canvasHeight={activeScreen.device.height}
                />
              ))}
            </div>
          </div>
          <RightSidebar />
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>

</html>